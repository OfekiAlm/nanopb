# Build and run validation test suite
# Tests all validation rules and behaviors

Import("env")

# Clone environment to set validation-specific options
test_env = env.Clone()

# Enable validation code generation via NANOPBFLAGS
# Also exclude validate.proto from #include list since it's only used for options
test_env.Replace(NANOPBFLAGS = "--validate,-x,validate.proto")

# Remove -ansi flag since pb_validate.h requires C99 features (inline)
# Also enable C99 for stdbool.h
cflags = str(test_env.get('CFLAGS', ''))
if '-ansi' in cflags:
    cflags = cflags.replace('-ansi', '')
test_env.Replace(CFLAGS = cflags + ' -std=c99 ')

# Prepend the build directory to CPPPATH so our generated headers are found
# before any system-wide google/protobuf headers
test_env.Prepend(CPPPATH = ['.'])

# Build pb_validate.o without extra strict flags (avoid conversion warnings)
test_env.Object("pb_validate.o", "$NANOPB/pb_validate.c")

# List of proto files to compile
protos = [
    "numeric_rules",
    "string_rules", 
    "repeated_rules",
    "enum_rules",
    "message_rules",
    "oneof_rules",
    "bytes_rules",
    "any_behavior"
]

# Generate nanopb sources for each proto file
# The NanopbProto builder generates .pb.c and .pb.h
# With --validate flag, it also generates _validate.c and _validate.h
# but we need to add _validate.c as a side effect
pb_sources = []
validate_sources = []

# Generate bypass_behavior proto with --bypass flag
bypass_env = test_env.Clone()
bypass_env.Replace(NANOPBFLAGS = "--validate,--bypass,-x,validate.proto")
pb_files = bypass_env.NanopbProto("bypass_behavior")
pb_sources.append("bypass_behavior.pb.c")
validate_c = "bypass_behavior_validate.c"
validate_h = "bypass_behavior_validate.h"
bypass_env.SideEffect(validate_c, pb_files)
bypass_env.SideEffect(validate_h, pb_files)
validate_sources.append(validate_c)


for proto in protos:
    pb_files = test_env.NanopbProto(proto)
    pb_sources.append(proto + ".pb.c")
    # Mark _validate.c as side effect of the proto compilation
    validate_c = proto + "_validate.c"
    validate_h = proto + "_validate.h"
    test_env.SideEffect(validate_c, pb_files)
    test_env.SideEffect(validate_h, pb_files)
    validate_sources.append(validate_c)

# Also need to compile Any proto with options for the any_behavior test
test_env.NanopbProto(["google/protobuf/any", "google/protobuf/any.options"])

# All C source files for the test binary
sources = ["test.c"] + ["google/protobuf/any.pb.c"] + pb_sources + validate_sources

# Build the test binary
test_prog = test_env.Program(
    sources + [
        "$COMMON/pb_encode.o",
        "$COMMON/pb_decode.o",
        "$COMMON/pb_common.o",
        "pb_validate.o"
    ]
)

# Run the test
test_env.RunTest(test_prog)

# ==================================================================================
# Nested import validation test - tests cross-file validation
# ==================================================================================

# Clone environment for nested import test
nested_env = env.Clone()

# Enable validation code generation
nested_env.Replace(NANOPBFLAGS = "--validate,-x,validate.proto")

# Remove -ansi flag and enable C99
cflags = str(nested_env.get('CFLAGS', ''))
if '-ansi' in cflags:
    cflags = cflags.replace('-ansi', '')
nested_env.Replace(CFLAGS = cflags + ' -std=c99 ')

# Prepend the build directory to CPPPATH
nested_env.Prepend(CPPPATH = ['.'])

# Build pb_validate.o for nested import test (reuse if already built)
nested_validate_obj = nested_env.Object("pb_validate_nested.o", "$NANOPB/pb_validate.c")

# Generate child.proto first (it's imported by parent.proto)
child_pb_files = nested_env.NanopbProto("child")
child_pb_sources = ["child.pb.c"]
child_validate_c = "child_validate.c"
child_validate_h = "child_validate.h"
nested_env.SideEffect(child_validate_c, child_pb_files)
nested_env.SideEffect(child_validate_h, child_pb_files)

# Generate parent.proto (imports child.proto)
parent_pb_files = nested_env.NanopbProto("parent")
parent_pb_sources = ["parent.pb.c"]
parent_validate_c = "parent_validate.c"
parent_validate_h = "parent_validate.h"
nested_env.SideEffect(parent_validate_c, parent_pb_files)
nested_env.SideEffect(parent_validate_h, parent_pb_files)

# Ensure parent.proto is generated after child.proto
nested_env.Depends(parent_pb_files, child_pb_files)

# Build the nested import test binary
nested_sources = [
    "test_nested_import.c",
    "child.pb.c",
    "child_validate.c",
    "parent.pb.c",
    "parent_validate.c"
]

nested_test_prog = nested_env.Program(
    "test_nested_import",
    nested_sources + [
        "$COMMON/pb_encode.o",
        "$COMMON/pb_decode.o",
        "$COMMON/pb_common.o",
        nested_validate_obj
    ]
)

# Run the nested import test
nested_env.RunTest(nested_test_prog)
