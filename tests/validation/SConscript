# Test the validation feature

Import("env")

# Enable validation for code generation
env = env.Clone()

# Use C99 standard instead of ansi for inline support
if '-ansi' in env.get('CFLAGS', []):
    env['CFLAGS'] = [f for f in env['CFLAGS'] if f != '-ansi']
    env.Append(CFLAGS = '-std=c99')

env.Append(PROTOCFLAGS = ['--nanopb_opt=--validate'])

# Copy stub validate.pb.h (validate.proto types are only used by Python generator)
env.Command("validate.pb.h", "validate_stub.pb.h", Copy("$TARGET", "$SOURCE"))

# Generate nanopb files with validation
env.NanopbProto("validation_test")

# Build the test program - link against validation runtime from parent directory
test = env.Program(["test_validation.c", "validation_test.pb.c", "validation_test_validate.c", 
                    "$COMMON/pb_encode.o", "$COMMON/pb_decode.o", "$COMMON/pb_common.o",
                    "#pb_validate.c"])

# Run the test
env.RunTest(test)
