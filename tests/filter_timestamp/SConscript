# Build and run filter_timestamp test suite
# Tests timestamp validation with gt_now, lt_now, and within rules

Import("env")

# Clone environment to set validation-specific options
test_env = env.Clone()

# Enable validation code generation with timestamp envelope mode
# Also exclude validate.proto from #include list since it's only used for options
# Specify envelope name for clarity
test_env.Replace(NANOPBFLAGS = "--validate,--envelope-mode=oneof,--envelope-name=FilterTimestampFuture,-x,validate.proto")

# Remove -ansi flag since pb_validate.h requires C99 features (inline)
# Also enable C99 for stdbool.h and time.h
cflags = str(test_env.get('CFLAGS', ''))
if '-ansi' in cflags:
    cflags = cflags.replace('-ansi', '')
test_env.Replace(CFLAGS = cflags + ' -std=c99 ')

# Prepend the build directory to CPPPATH so our generated headers are found
# before any system-wide google/protobuf headers
test_env.Prepend(CPPPATH = ['.'])

# Build pb_validate.o without extra strict flags (avoid conversion warnings)
test_env.Object("pb_validate.o", "$NANOPB/pb_validate.c")

# Generate nanopb sources for the proto file
# The NanopbProto builder generates .pb.c and .pb.h
# With --validate flag, it also generates _validate.c and _validate.h
pb_files = test_env.NanopbProto("filter_timestamp")
pb_sources = ["filter_timestamp.pb.c"]
validate_c = "filter_timestamp_validate.c"
validate_h = "filter_timestamp_validate.h"
test_env.SideEffect(validate_c, pb_files)
test_env.SideEffect(validate_h, pb_files)
validate_sources = [validate_c]

# Also need to compile Timestamp proto with options for the timestamp field
# Use a separate environment without validation for google.protobuf.Timestamp
timestamp_env = test_env.Clone()
timestamp_env.Replace(NANOPBFLAGS = "-x,validate.proto")
timestamp_env.NanopbProto(["google/protobuf/timestamp", "google/protobuf/timestamp.options"])

# All C source files for the test binary
sources = ["test_filter_timestamp.c"] + ["google/protobuf/timestamp.pb.c"] + pb_sources + validate_sources

# Build the test binary
test_prog = test_env.Program(
    sources + [
        "$COMMON/pb_encode.o",
        "$COMMON/pb_decode.o",
        "$COMMON/pb_common.o",
        "pb_validate.o"
    ]
)

# Run the test
test_env.RunTest(test_prog)
