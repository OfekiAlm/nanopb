# Oneof and Any Validation Tests

This directory contains SCons-based tests for oneof and google.protobuf.Any validation using nanopb generated validators.

## Test Directories

### filter_oneof

Tests validation of messages containing oneof fields using generated pb_validate_* functions.

**Key Features:**
- Tests header opcode field with range validation (1-3)
- Tests oneof payload with three variants:
  - `auth_username`: String field with min_len validation (>= 3 chars)
  - `data_value`: Int32 field with non-negative validation (>= 0)
  - `status`: Nested message type (demonstrates structure)
- Uses generated pb_validate_FilterOneofMessage() function directly
- Validates correct rejection of invalid messages with proper violation codes
- Validates correct acceptance of valid messages

**Test Coverage:**
- Valid and invalid scalar oneof members (string, int32)
- Boundary condition testing (empty strings, zero values)
- Out-of-range opcode validation
- Nested message types in oneofs (with manual validation example)

**Build and Run:**
```bash
cd tests
scons filter_oneof
```

### filter_any

Tests validation of messages containing google.protobuf.Any fields using generated pb_validate_* functions.

**Key Features:**
- Tests `any.in` validation (whitelist of allowed type_urls)
  - Allows: `type.googleapis.com/UserInfo` and `type.googleapis.com/ProductInfo`
  - Rejects: any other type_url
- Tests `any.not_in` validation (blacklist of disallowed type_urls)
  - Disallows: `type.googleapis.com/OrderInfo`
  - Allows: all other type_urls
- Helper function pack_any() to populate Any fields with serialized messages
- Validates type_url constraints before accessing message content

**Test Coverage:**
- Valid Any with allowed type_url
- Invalid Any with disallowed type_url
- Invalid Any with unknown type_url
- Any.in rule validation (whitelist)
- Any.not_in rule validation (blacklist)
- Proper Any packing (type_url + serialized bytes)

**Build and Run:**
```bash
cd tests
scons filter_any
```

## Implementation Details

### Proto File Generation

Both tests use the nanopb generator with the `--validate` flag to generate validation code:
- `*.pb.c` / `*.pb.h`: Standard nanopb message structures
- `*_validate.c` / `*_validate.h`: Generated validation functions

### Direct Validation Approach

The tests use generated validation functions directly:
1. Construct message structures in memory
2. Call pb_validate_* functions (e.g., `pb_validate_FilterOneofMessage()`)
3. Check boolean return value (true = valid, false = invalid)
4. Inspect pb_violations_t structure for specific constraint violations

### Validation Flow

```
Message Construction → pb_validate_*() → Check Result & Violations
```

This direct approach is simpler and more efficient than encoding/decoding through a network filter, while still exercising the full validation logic generated by nanopb_generator.py.

## Known Limitations

### Nested Messages in Oneofs

The nanopb validator generator currently does not automatically generate validation for nested message types within oneof fields. For example, in `filter_oneof.proto`, the `StatusPayload` message within the oneof requires manual validation if needed:

```c
// Manual validation of nested message
StatusPayload status = StatusPayload_init_zero;
// ... set fields ...
pb_violations_t viol;
pb_violations_init(&viol);
bool ok = pb_validate_StatusPayload(&status, &viol);
```

This is a known limitation of the generator and is documented in the test code.

## Test Structure

Both tests follow a similar pattern:
1. **Setup**: Initialize message structures and filter specs
2. **Register**: Register the filter spec with `proto_filter_register()`
3. **Test Cases**:
   - Construct valid/invalid messages
   - Encode to binary format
   - Call filter_tcp/udp
   - Assert expected behavior
4. **Summary**: Report pass/fail counts

Each test is self-contained and reports clear pass/fail status for debugging.
